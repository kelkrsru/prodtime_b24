{% extends 'base.html' %}

{% block title %}–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–¥–µ–ª–∫–∏{% endblock %}
{% block content %}
  <div id="div-loader" style="width: 100%; height: 100%; opacity: 0.5; position: fixed; background: #bacbe6; z-index: 100; text-align: center; display: none">
    {% load static %}
    <img src="{% static 'img/loading.gif' %}" alt="loading gif">
  </div>
  <div class="container mt-5">
    <div class="card bg-light">
      <div class="card-body">
        <div class="row">
          <div class="col-2">
            <div class="card text-center fw-bold">
              <div class="card-header bg-primary text-white justify-content-center">
                <span>–°—É–º–º–∞—Ä–Ω—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç</span>
              </div>
              <div class="card-body">
                <span id="sum-equivalent">{{ sum_equivalent }}</span>
              </div>
            </div>
          </div>
          <div class="col-10">
            <div class="d-flex flex-row-reverse align-items-center">
              <a href="{% url 'dealcard:index' %}?member_id={{ member_id }}&deal_id={{ deal_id }}" class="btn btn-outline-success ms-3">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–¥–µ–ª–∫–∏</a>
              <label for="show-all">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ –ø–æ–ª—è</label>
              <input class="form-check-input me-3" type="checkbox" id="show-all" onclick="showAll()">
            </div>
            <div class="d-flex flex-row-reverse align-items-center mt-3">
              <a href="{% url 'dealcard:export-excel' %}?member_id={{ member_id }}&deal_id={{ deal_id }}" target="_blank" class="btn btn-outline-primary">–í—ã–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ Excel</a>
              <button class="btn btn-outline-primary me-3" onclick="copyProducts()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ –∏ —Å–¥–µ–ª–∫—É</button>
              <button class="btn btn-outline-primary me-3" onclick="sendEquivalent()">–ü–µ—Ä–µ–¥–∞—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ —Å–¥–µ–ª–∫—É</button>
            </div>
            <div class="row d-flex flex-row-reverse align-items-center mt-3">
              <button class="col btn btn-outline-primary" onclick="WriteFactoryNumbers()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–æ–¥—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞</button>
              <input class="col form-control me-3" type="text" id="general-number" value="{{ deal.general_number }}">
              <label class="col text-end" for="general-number">–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –∑–∞–≤–æ–¥—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞:</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container mt-3">
    <table class="table table-striped align-baseline" id="main-table">
      <thead>
        <tr>
          <th scope="col" width="3%" id="num">#</th>
          <th scope="col" width="15%" id="prod">–¢–æ–≤–∞—Ä</th>
          <th scope="col" width="15%" id="print-form">–í –ø–µ—á–∞—Ç–Ω—É—é —Ñ–æ—Ä–º—É</th>
          <th scope="col" width="10%" id="price">–¶–µ–Ω–∞, —Ä—É–±.</th>
          <th scope="col" width="8%" id="count">–ö–æ–ª-–≤–æ</th>
          <th scope="col" width="5%" id="unit">–ï–¥. –∏–∑–º.</th>

          <th scope="col" id="bonus" class="td-hidden">–°–∫–∏–¥–∫–∞, %</th>
          <th scope="col" id="bonus-sum" class="td-hidden">–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏, —Ä—É–±.</th>
          <th scope="col" id="tax" class="td-hidden">–ù–∞–ª–æ–≥, %</th>
          <th scope="col" id="tax-sum" class="td-hidden">–°—É–º–º–∞ –Ω–∞–ª–æ–≥–∞, —Ä—É–±.</th>

          <th scope="col" width="9%" id="sum">–°—É–º–º–∞, —Ä—É–±.</th>
{#          <th scope="col" width="8%" id="count-days">–ö–æ–ª-–≤–æ —Ä–∞–±. –¥–Ω–µ–π</th>#}
          <th scope="col" width="8%" id="equivalent">–≠–∫–≤-–Ω—Ç –∑–∞ 1 –µ–¥.</th>
          <th scope="col" width="10%" id="prod-time">–°—Ä–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</th>
          <th scope="col" width="8%" id="factory-number">–ó–∞–≤. –Ω–æ–º–µ—Ä</th>
          <th scope="col" width="3%" id="edit-number">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä</th>
          <th scope="col" width="3%" id="made">–ì–æ—Ç–æ–≤–æ</th>
          <th scope="col" width="3%" id="finish">–í—ã–ø—É—Å–∫</th>
        </tr>
      </thead>
      <tbody>
        {% if products %}
          {% for product in products %}
            <tr>
              <th scope="row">{{ forloop.counter }}</th> {# –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ #}
              <td>{{ product.name }}</td> {# –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ #}
              <td data-id="{{ product.id }}"><textarea class="form-control text-input" name="print-form-1" oninput='this.style.height = "";this.style.height = this.scrollHeight + "px"'>{{ product.name_for_print }}</textarea></td>
              <td>{{ product.price_netto}}</td> {# –¶–µ–Ω–∞ –∑–∞ —à—Ç—É–∫—É #}
              <td>{{ product.quantity }}</td> {# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ #}
              <td>{{ product.measure_name }}</td> {# –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è #}

              <td class="td-hidden">{{ product.bonus }}</td> {# –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ #}
              <td class="td-hidden">{{ product.bonus_sum }}</td> {# –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ #}
              <td class="td-hidden">{{ product.tax }}</td> {# –ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞–ª–æ–≥–∞ #}
              <td class="td-hidden">{{ product.tax_sum }}</td> {# –°—É–º–º–∞ –Ω–∞–ª–æ–≥–∞ #}

              <td>{{ product.sum }}</td> {# –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å –Ω–∞–ª–æ–≥–æ–º –∏ —Å–∫–∏–¥–∫–æ–π #}
{#              <td data-id="{{ product.id }}"><input class="form-control number-input" type="number" name="count-days-1"#}
{#                           value="{{ product.count_days }}"></td> {# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π #}
              <td data-id="{{ product.id }}"><input class="form-control equivalent-input" type="number" name="equivalent-1"
                           value="{{ product.equivalent }}"></td> {# –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç #}
              <td data-id="{{ product.id }}"><input type="date" class="form-control datepicker-input"
                         name="prod-time-1" value="{{ product.prod_time|date:'Y-m-d' }}"></td> {# –°—Ä–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ #}
              {% if product.factory_number %}
                <td data-id="{{ product.id }}"><input id="{{ product.id }}" type="text" class="form-control factory-number-input"
                         name="factory-number-1" value="{{ product.factory_number }}" readonly></td> {# –ó–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä #}
                <td data-id="{{ product.id }}"><button class="btn btn-outline-info factory-number-btn" title="–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä">üî¢</button></td> {# –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä #}
              {% else %}
                <td data-id="{{ product.id }}"><input id="{{ product.id }}" type="text" class="form-control factory-number-input"
                         name="factory-number-1" value="–ù–µ –∑–∞–¥–∞–Ω" readonly disabled></td> {# –ó–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä #}
                <td data-id="{{ product.id }}"><button class="btn btn-outline-info" disabled>üî¢</button></td> {# –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–≤–æ–¥—Å–∫–æ–π –Ω–æ–º–µ—Ä #}
              {% endif %}
              {% if product.made == True %}
                <td data-id="{{ product.id }}"><input data-id="{{ product.id }}" class="form-check-input made-check-input" type="checkbox" checked></td> {# –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏–∑–¥–µ–ª–∏—è #}
              {% else %}
                <td data-id="{{ product.id }}"><input data-id="{{ product.id }}" class="form-check-input made-check-input" type="checkbox"></td> {# –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏–∑–¥–µ–ª–∏—è #}
              {% endif %}
              {% if product.finish == True %}
                <td data-id="{{ product.id }}"><input data-id="{{ product.id }}" class="form-check-input finish-check-input" type="checkbox" checked></td> {# –í—ã–ø—É—Å–∫ –∏–∑–¥–µ–ª–∏—è #}
              {% else %}
                <td data-id="{{ product.id }}"><input data-id="{{ product.id }}" class="form-check-input finish-check-input" type="checkbox"></td> {# –í—ã–ø—É—Å–∫ –∏–∑–¥–µ–ª–∏—è #}
              {% endif %}
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="11">–¢–æ–≤–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å–¥–µ–ª–∫–µ</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="container mt-3">
    <div class="row">
      <div class="d-flex flex-row-reverse align-items-center mt-3">
        <button class="btn btn-outline-primary btn-lg" onclick="ProductsFinish()">–ò–∑–¥–µ–ª–∏–µ –≤—ã–ø—É—â–µ–Ω–æ</button>
        <button class="btn btn-outline-primary me-3 btn-lg" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" onclick="CheckAll()">‚úÖ</button>
        <button class="btn btn-outline-primary me-3 btn-lg" title="–°–Ω—è—Ç—å –≤—Å–µ" onclick="NoCheckAll()">‚ùé</button>
      </div>
    </div>
  </div>
{% endblock %}
{% block user_scripts %}
  <script>
    $(".factory-number-btn").click(function() {
        const td = $(this).parent("td");
        const name_elem = "#" + td.data("id");
        $(name_elem).removeAttr('readonly');
    })

    $(".factory-number-input").focus(function() {
        $(this).removeClass('text-danger');
    });

    $(".factory-number-input").blur(function() {
        const value = $(this).val();
        const td = $(this).parent("td");
        updateFactoryNumber(td.data("id"),value,this);
    });

    $(".finish-check-input").change(function() {
        const td = $(this).parent("td");
        if (this.checked === false){
            sendToServer(td.data("id"),'false','finish');
        }
    });

    $(".made-check-input").change(function() {
        const td = $(this).parent("td");
        if (this.checked === false){
            sendToServer(td.data("id"),'false','made');
        }
        if (this.checked === true){
            sendToServer(td.data("id"),'true','made');
        }
    });

    $(".datepicker-input").focus(function() {
        $(this).removeClass('text-success');
        $(this).removeClass('text-danger');
    });

    $(".datepicker-input").blur(function() {
        const value = $(this).val();
        const td = $(this).parent("td");
        sendToServer(td.data("id"),value,'prod-time',this);
    });

    $(".number-input").focus(function() {
        $(this).removeClass('text-success');
        $(this).removeClass('text-danger');
    });

    $(".number-input").blur(function() {
        const value = $(this).val();
        const td = $(this).parent("td");
        sendToServer(td.data("id"),value,'count-days',this);
    });

    $(".equivalent-input").focus(function() {
        $(this).removeClass('text-success');
        $(this).removeClass('text-danger');
    });

    $(".equivalent-input").blur(function() {
        const value = $(this).val();
        const td = $(this).parent("td");
        sendToServer(td.data("id"),value,'equivalent',this);
    });

    $(".text-input").focus(function() {
        $(this).removeClass('text-success');
        $(this).removeClass('text-danger');
    });

    $(".text-input").blur(function() {
        const value = $(this).val();
        const td = $(this).parent("td");
        sendToServer(td.data("id"),value,'name-for-print',this);
    });

    $("#general-number").focus(function() {
        $(this).removeClass('text-success');
        $(this).removeClass('text-danger');
    });

    $("#general-number").blur(function() {
        const value = $(this).val();
        sendToServer({{ deal.pk }},value,'general-number',this);
    });

    function sendToServer(id,value,type,control) {
        $.ajax({
            url: "{% url 'dealcard:save' %}",
            type: "POST",
            data: {id: id, type: type, value: value},
        })
            .done(function () {
                $(control).removeClass('text-danger');
                $(control).addClass('text-success');
            })
            .fail(function () {
                $(control).removeClass('text-success');
                $(control).addClass('text-danger');
            });
    }

    function updateFactoryNumber(id,value,control) {
        $.ajax({
            url: "{% url 'dealcard:update-factory-number' %}",
            type: "POST",
            data: {product_id: id, value: value, member_id: "{{ member_id }}"},
        })
            .done(function (response) {
                if(response.result === 'error'){
                    alert(response.info);
                    $(control).addClass('text-danger');
                }
                else if(response.result === 'success'){
                    $(control).removeClass('text-danger');
                    $(control).attr('readonly', '');
                }
            })
            .fail(function () {
                $(control).removeClass('text-success');
                $(control).addClass('text-danger');
            });
    }

    function createTaskandDeal(id, member_id) {
        $.ajax({
            url: "{% url 'dealcard:create' %}",
            type: "POST",
            data: {id: id, member_id: member_id},
        })
            .done(function (response) {
                if(response.result === 'nodeal'){
                    alert(response.info);
                }
                else if(response.result === 'notask'){
                    alert(response.info);
                }
                else if(response.result === 'dealandtask'){
                    alert(response.info);
                }
            })
            .fail(function () {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏ –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É');
            });
    }

    function ProductsFinish() {
        const elements = document.getElementsByClassName('finish-check-input');
        const elementsList = Array.prototype.slice.call(elements);
        const products_id = [];
        elementsList.forEach(function (item, i, arr) {
            if(item.checked === true) {
                products_id.push(item.dataset.id);
            }
        });
        if(products_id.length === 0){
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç');
            return;
        }
        $.ajax({
            url: "{% url 'dealcard:create' %}",
            type: "POST",
            data: {products_id: products_id, member_id: "{{ member_id }}", deal_id: "{{ deal_id }}"},
        })
            .done(function (response) {
                alert(response.info);
            })
            .fail(function () {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏ –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É');
            });
    }

    function CheckAll() {
        const elements = document.getElementsByClassName('finish-check-input');
        const elementsList = Array.prototype.slice.call(elements);
        elementsList.forEach(function (item, i, arr) {
            item.checked = true;
        });
    }

    function NoCheckAll() {
        const elements = document.getElementsByClassName('finish-check-input');
        const elementsList = Array.prototype.slice.call(elements);
        elementsList.forEach(function (item, i, arr) {
            item.checked = false;
        });
    }

    function WriteFactoryNumbers() {
        document.getElementById("div-loader").style.display = "block";
        $.ajax({
            url: "{% url 'dealcard:write-factory-number' %}",
            type: "POST",
            data: {member_id: "{{ member_id }}", deal_id: "{{ deal_id }}"},
        })
            .done(function (response) {
                document.getElementById("div-loader").style.display = "none";
                alert(response.info);
                window.location.href = "{% url 'dealcard:index' %}?member_id={{ member_id }}&deal_id={{ deal_id }}";
            })
            .fail(function () {
                document.getElementById("div-loader").style.display = "none";
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–≤–æ–¥—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤');
            });
    }

    function copyProducts() {
        document.getElementById("div-loader").style.display = "block";
        $.ajax({
            url: "{% url 'dealcard:copy-products' %}",
            type: "POST",
            data: {member_id: "{{ member_id }}", deal_id: "{{ deal_id }}"},
        })
            .done(function (response) {
                document.getElementById("div-loader").style.display = "none";
                alert(response.info);
                window.location.href = "{% url 'dealcard:index' %}?member_id={{ member_id }}&deal_id={{ deal_id }}";
            })
            .fail(function () {
                document.getElementById("div-loader").style.display = "none";
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–≤–æ–¥—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤');
            });
    }

    function sendEquivalent() {
        $.ajax({
            url: "{% url 'dealcard:send-equivalent' %}",
            type: "POST",
            data: {member_id: "{{ member_id }}", deal_id: "{{ deal_id }}"},
        })
            .done(function (response) {
                alert("–°—É–º–º–∞—Ä–Ω—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞–Ω –≤ —Å–¥–µ–ª–∫—É –≤ —Ä–∞–∑–º–µ—Ä–µ " + response.result)
            })
            .fail(function () {
                alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞ –≤ —Å–¥–µ–ª–∫—É');
            });
    }
  </script>

{% endblock %}